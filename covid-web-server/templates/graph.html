<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../static/stylesheets/style_graph.css">
    <title>Covid public restrictions</title>
    <style type="text/css">
    </style>
    <script src="static/libs/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
    <script src="static/libs/plotly-latest.min.js"></script>

  <script>

    var selectedTable;
    var selectedDate;
    var tables;
    var dates;

   $(document).ready(function(){
        selectedTable = 'home'
        selectedDate = 'today'

        updateDates()
        updateTables()

        getData()

   });  //Documnt ready

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function updateDates() {
        $.ajax({
        type: "POST",
        url: '/dates/'+selectedTable,
        success:function(data)
        {
            dates = [];
            dates.length = 0
            console.log('/dates');
            console.log(data);
            dates = JSON.parse(data)
            console.log(selectedDate);

            var select = document.getElementById("date_id");

           var length = select.options.length;
            for (i = length-1; i > 0; i--) {
              select.options[i] = null;
            }

            for(var i = 0; i < dates.length; i++) {
                var opt = dates[i];
                var el = document.createElement("option");
                el.textContent = opt;
                el.value = opt;
                select.appendChild(el);
            };
        }
        }).done(function( o ) {
        });
    }

    function updateTables() {
        $.ajax({
        type: "POST",
        url: '/tables',
        success:function(data)
        {
            console.log('/tables');
            console.log(data);
            tables = [];
            tables = JSON.parse(data)

            var select = document.getElementById("place_id");

            var length = select.options.length;
            for (i = length-1; i > 0; i--) {
              select.options[i] = null;
            }

            for(var i = 0; i < tables.length; i++) {
                var opt = tables[i];
                var el = document.createElement("option");
                el.textContent = opt;
                el.value = opt;
                select.appendChild(el);
            };
        }
        }).done(function( o ) {

        });
    }

    var trace;
    var layout = {
          title: 'Number of people inside closed space',
          xaxis: {
            title: 'time',
            tickformat: '%HH:%MM:%SS'
          },
          yaxis: {
            title: 'people',
          }
        };

    function drawGraph(data) {
        console.log(data);
        data = JSON.parse(data);

        $('#log').append(data).html();

        console.log(data);
        n = Object.keys(data).length;
        console.log(n);

        xl = [];
        yl = [];

        date = data[0].date

        for (var i=0; i< n; i++){
            xl.push(data[i].time);
            yl.push(data[i].counter);
        }

        trace = {
            x: xl,
            y: yl,
            name: 'sin',
            type: 'bar'
        };
        var traces = new Array();
        traces.push(trace);
        Plotly.newPlot($('#plotdiv')[0], traces,layout);
    }

    function getData(){
        $.ajax({
          type: "POST",
          url: '/database/'+selectedTable.toString()+'/'+selectedDate,

          success:function(data)
          {
              drawGraph(data)
          }
        }).done(function( o ) {

        });
         return false;
    }

    function selectPlace(selectObject) {
        selectedTable = selectObject.value;
        updateDates()
        console.log(dates)
        selectedDate = dates[0]
        getData()
    }

    function selectDate(selectObject) {
        selectedDate = selectObject.value;
        getData()
    }

     function updateGraphButton(object) {
          console.log("update button")
          getData();
          return false;
      }

  </script>
</head>

<body>

    <h2> Choose place and date from available options in database </h2>
     <br>

    <div style=" float:left; width: 300px; position: absolute; left: 50px;">
      <select id="place_id"  onchange="selectPlace(this)" class="select-css" >
        <option>Select place</option>
      </select>
    </div>

    <div style=" position: absolute; left: 300px; width: 300px">
      <select id="date_id", onchange="selectDate(this)" class="select-css">
        <option>Select date</option>
      </select>
    </div>

    <br>
    <br>
    <br>

    <div id="plotdiv" style="width:600px;height:250px;"></div>
    <br>
    <button class="example_c"  style="position: absolute; left: 200px" onclick="updateGraphButton()">Update graph</button>

</body>
</html>